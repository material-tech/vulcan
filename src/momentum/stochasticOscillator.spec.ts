import { format } from 'dnum'
import { describe, expect, it } from 'vitest'
import { stoch } from './stochasticOscillator'

describe('stochastic oscillator (STOCH)', () => {
  const klineData = [
    { h: 127.01, l: 125.36, c: 126.00, o: 125.00 },
    { h: 127.62, l: 126.16, c: 126.60, o: 126.00 },
    { h: 126.59, l: 124.93, c: 127.10, o: 126.60 },
    { h: 127.35, l: 126.09, c: 127.20, o: 127.10 },
    { h: 128.17, l: 126.82, c: 128.10, o: 127.20 },
    { h: 128.43, l: 126.48, c: 128.20, o: 128.10 },
    { h: 127.37, l: 126.03, c: 126.30, o: 128.20 },
    { h: 126.42, l: 124.83, c: 126.00, o: 126.30 },
    { h: 126.90, l: 126.39, c: 126.60, o: 126.00 },
    { h: 126.85, l: 125.72, c: 127.00, o: 126.60 },
    { h: 125.65, l: 124.56, c: 127.50, o: 127.00 },
    { h: 125.72, l: 124.57, c: 128.00, o: 127.50 },
    { h: 127.16, l: 125.07, c: 128.10, o: 128.00 },
    { h: 127.72, l: 126.86, c: 127.29, o: 128.10 },
    { h: 127.69, l: 126.63, c: 127.18, o: 127.29 },
    { h: 128.22, l: 126.80, c: 128.01, o: 127.18 },
    { h: 128.27, l: 126.71, c: 127.11, o: 128.01 },
    { h: 128.09, l: 126.80, c: 127.73, o: 127.11 },
    { h: 128.27, l: 126.13, c: 127.06, o: 127.73 },
    { h: 127.74, l: 125.92, c: 127.33, o: 127.06 },
  ]

  it('should be able get k and d', () => {
    const expectedK = ['38.79', '54.87', '80.67', '84.39', '97.84', '93.43', '39.14', '32.5', '49.17', '60.28', '75.97', '88.89', '91.47', '70.54', '67.7', '89.15', '65.89', '85.44', '67.39', '74.66']
    const expectedD = ['38.79', '46.83', '67.77', '82.53', '91.11', '95.63', '66.29', '35.82', '40.83', '54.72', '68.12', '82.43', '90.18', '81.01', '69.12', '78.42', '77.52', '75.67', '76.42', '71.02']

    const actual = stoch(klineData, { kPeriod: 12, dPeriod: 2 })
    expect(actual.k.map(v => format(v, { digits: 2 }))).toStrictEqual(expectedK)
    expect(actual.d.map(v => format(v, { digits: 2 }))).toStrictEqual(expectedD)
  })
})
