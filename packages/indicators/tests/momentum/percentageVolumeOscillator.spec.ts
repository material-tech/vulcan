/* eslint-disable antfu/consistent-list-newline */
import { collect } from '@vulcan-js/core'
import { pvo } from '@vulcan-js/indicators'
import { describe, expect, it } from 'vitest'

describe('percentage volume oscillator (PVO)', () => {
  const volumes = [
    7849100, 7221300, 6911900, 4992300, 4684400, 4330200, 5883500, 3899700,
    3564800, 3632100, 4018600, 3241600, 5765200, 5368200, 4351900, 4832100,
    4287600, 6152400, 5765800, 5204600, 7553100, 4703000, 6265700, 4913400,
    5207500, 5675900, 5366200, 4386500, 4682200, 3773300, 3895400, 4320900,
    4670000, 5789600, 4401500, 5246900, 4101400, 4724900, 6470600, 5587500,
    5042400, 4584700, 4071200, 5765300, 4884800, 6464600, 5135700, 4246400,
    3823400, 4559400, 4325300, 4219400, 4234000, 5765300, 4940700, 3962100,
    4161300, 6085900, 5237900, 5743500, 5759000, 5086200, 5662000, 5216900,
    4851300, 6367600, 5621000, 4946400, 4444000, 3735100, 4171600, 5728100,
    5765300, 5242700, 4287000, 3717500, 4373400, 5236100, 4993200, 4802300,
    6177200, 5235600, 4761300, 4351000, 6413600, 5357300, 6117700, 5161800,
    5481200, 5340300,
  ]

  it('should calculate PVO with default options', () => {
    const result = collect(pvo(volumes))

    const expectedPVO = [
      0, -0.64, -1.47, -4.18, -6.74, -9.24, -9.31, -11.8, -14.27, -16.16,
      -17.04, -18.86, -16.23, -14.58, -14.7, -13.91, -14, -10.98, -9.09, -8.37,
      -4.22, -5.1, -3.47, -4.11, -4.14, -3.44, -3.3, -4.61, -5.17, -7, -8.24,
      -8.47, -7.98, -5.67, -6.05, -4.91, -5.84, -5.48, -2.3, -1.23, -1.23,
      -1.95, -3.33, -1.65, -1.72, 0.71, 0.53, -1, -2.9, -3.2, -3.79, -4.4,
      -4.83, -2.5, -2.05, -3.31, -3.95, -1.15, -0.38, 1.03, 2.11, 1.88, 2.57,
      2.39, 1.65, 3.38, 3.54, 2.61, 1.09, -1.27, -2.46, -0.84, 0.47, 0.67,
      -0.7, -2.72, -3.23, -2.15, -1.69, -1.62, 0.67, 0.93, 0.38, -0.73, 1.7,
      1.89, 3.17, 2.69, 2.76, 2.57,
    ]
    const expectedSignal = [
      0, -0.13, -0.4, -1.15, -2.27, -3.67, -4.79, -6.2, -7.81, -9.48,
      -10.99, -12.57, -13.3, -13.55, -13.78, -13.81, -13.85, -13.27, -12.44,
      -11.62, -10.14, -9.13, -8, -7.22, -6.61, -5.97, -5.44, -5.27, -5.25,
      -5.6, -6.13, -6.6, -6.88, -6.63, -6.52, -6.2, -6.12, -5.99, -5.25,
      -4.45, -3.81, -3.43, -3.41, -3.06, -2.79, -2.09, -1.57, -1.45, -1.74,
      -2.03, -2.38, -2.79, -3.2, -3.06, -2.86, -2.95, -3.15, -2.75, -2.27,
      -1.61, -0.87, -0.32, 0.26, 0.68, 0.88, 1.38, 1.81, 1.97, 1.79, 1.18,
      0.45, 0.19, 0.25, 0.33, 0.13, -0.44, -1, -1.23, -1.32, -1.38, -0.97,
      -0.59, -0.4, -0.46, -0.03, 0.35, 0.92, 1.27, 1.57, 1.77,
    ]
    const expectedHistogram = [
      0, -0.51, -1.07, -3.03, -4.47, -5.58, -4.51, -5.61, -6.46, -6.68,
      -6.05, -6.29, -2.93, -1.03, -0.92, -0.1, -0.16, 2.3, 3.34, 3.25, 5.92,
      4.03, 4.53, 3.12, 2.46, 2.53, 2.14, 0.66, 0.08, -1.4, -2.11, -1.87,
      -1.11, 0.97, 0.46, 1.29, 0.29, 0.52, 2.96, 3.22, 2.57, 1.49, 0.09,
      1.41, 1.07, 2.8, 2.1, 0.46, -1.16, -1.16, -1.4, -1.62, -1.63, 0.55,
      0.81, -0.36, -0.8, 1.6, 1.89, 2.64, 2.98, 2.2, 2.31, 1.7, 0.78, 2,
      1.73, 0.64, -0.71, -2.45, -2.91, -1.03, 0.22, 0.33, -0.82, -2.28,
      -2.23, -0.92, -0.37, -0.24, 1.64, 1.52, 0.77, -0.26, 1.73, 1.54, 2.26,
      1.42, 1.19, 0.8,
    ]

    expect(result.map(p => p.pvo)).toMatchNumberArray(expectedPVO, { digits: 2 })
    expect(result.map(p => p.signal)).toMatchNumberArray(expectedSignal, { digits: 2 })
    expect(result.map(p => p.histogram)).toMatchNumberArray(expectedHistogram, { digits: 2 })
  })

  it('should calculate PVO with custom options', () => {
    const result = collect(pvo(volumes, {
      fastPeriod: 6,
      slowPeriod: 13,
      signalPeriod: 7,
    }))

    const expectedPVO = [
      0, -1.16, -2.42, -7.03, -10.63, -13.62, -11.3, -14.51, -17.29, -18.52,
      -17.56, -18.98, -10.89, -6.83, -7.12, -5.57, -6.05, -0.55, 1.59, 1.27,
      7.05, 3.02, 4.38, 1.59, 0.56, 1.13, 0.62, -2.36, -3.35, -6.56, -8.07,
      -7.39, -5.57, -0.82, -2.06, -0.22, -2.51, -1.94, 3.54, 4.11, 2.8, 0.6,
      -2.32, 0.91, 0.31, 4.27, 2.88, -0.56, -4.02, -3.84, -4.31, -4.78,
      -4.86, 0.07, 0.52, -2.19, -3.21, 2.18, 2.76, 4.38, 5.18, 3.63, 4.08,
      2.99, 1.21, 4.13, 3.73, 1.58, -1.21, -5.05, -6.05, -1.72, 0.99, 1.12,
      -1.55, -4.95, -4.91, -2.02, -0.93, -0.79, 3.26, 2.89, 1.23, -1.03,
      3.44, 3.06, 4.69, 2.98, 2.65, 1.97,
    ]
    const expectedSignal = [
      0, -0.29, -0.82, -2.37, -4.44, -6.73, -7.88, -9.53, -11.47, -13.23,
      -14.32, -15.48, -14.33, -12.46, -11.12, -9.73, -8.81, -6.75, -4.66,
      -3.18, -0.62, 0.29, 1.31, 1.38, 1.17, 1.16, 1.03, 0.18, -0.7, -2.17,
      -3.64, -4.58, -4.83, -3.83, -3.38, -2.59, -2.57, -2.41, -0.93, 0.33,
      0.95, 0.86, 0.06, 0.28, 0.28, 1.28, 1.68, 1.12, -0.17, -1.08, -1.89,
      -2.62, -3.18, -2.36, -1.64, -1.78, -2.14, -1.06, -0.11, 1.02, 2.06,
      2.45, 2.86, 2.89, 2.47, 2.88, 3.1, 2.72, 1.73, 0.04, -1.48, -1.54,
      -0.91, -0.4, -0.69, -1.75, -2.54, -2.41, -2.04, -1.73, -0.48, 0.36,
      0.58, 0.18, 0.99, 1.51, 2.3, 2.47, 2.52, 2.38,
    ]
    const expectedHistogram = [
      0, -0.87, -1.6, -4.65, -6.19, -6.89, -3.42, -4.98, -5.81, -5.28,
      -3.25, -3.5, 3.44, 5.63, 4, 4.17, 2.76, 6.2, 6.25, 4.45, 7.67, 2.73,
      3.07, 0.21, -0.62, -0.04, -0.41, -2.54, -2.65, -4.39, -4.43, -2.81,
      -0.74, 3.01, 1.33, 2.37, 0.06, 0.47, 4.46, 3.77, 1.85, -0.26, -2.39,
      0.64, 0.02, 2.99, 1.2, -1.68, -3.85, -2.76, -2.42, -2.17, -1.68, 2.44,
      2.16, -0.41, -1.08, 3.24, 2.86, 3.37, 3.12, 1.18, 1.22, 0.1, -1.26,
      1.24, 0.64, -1.14, -2.95, -5.09, -4.57, -0.18, 1.9, 1.52, -0.86,
      -3.19, -2.36, 0.39, 1.11, 0.94, 3.74, 2.53, 0.65, -1.21, 2.45, 1.55,
      2.39, 0.51, 0.13, -0.41,
    ]

    expect(result.map(p => p.pvo)).toMatchNumberArray(expectedPVO, { digits: 2 })
    expect(result.map(p => p.signal)).toMatchNumberArray(expectedSignal, { digits: 2 })
    expect(result.map(p => p.histogram)).toMatchNumberArray(expectedHistogram, { digits: 2 })
  })
})
