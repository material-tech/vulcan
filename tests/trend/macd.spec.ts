/* eslint-disable antfu/consistent-list-newline */
import { toNumber } from 'dnum'
import { describe, expect, it } from 'vitest'
import { mapOperator } from '~/helpers/operations'
import { macd } from '~/trend/macd'

describe('moving average convergence divergence (MACD)', () => {
  const values = [
    3674.84, 3666.77, 3789.99, 3735.48, 3749.63, 3900.86, 4017.82, 4115.77,
    4160.68, 4121.43, 4108.54, 4176.82, 4101.23, 4132.15, 4158.24, 4057.84,
    3978.73, 3941.48, 3973.75, 3901.36, 3900.79, 3923.68, 4088.85, 4008.01,
    4023.89, 3930.08, 3935.18, 4001.05, 3991.24, 4123.34, 4146.87, 4300.17,
    4175.48, 4155.38, 4131.93, 4287.5, 4183.96, 4175.2, 4296.12, 4271.78,
    4393.66, 4459.45, 4462.21, 4391.69, 4392.59, 4446.59, 4397.45, 4412.53,
    4488.28, 4500.21, 4481.15, 4525.12, 4582.64, 4545.86, 4530.41, 4602.45,
    4631.6, 4575.52, 4543.06, 4520.16, 4456.24, 4511.61, 4461.18, 4463.12,
    4411.67, 4357.86, 4262.45, 4173.11, 4204.31, 4259.52, 4277.88, 4170.7,
    4201.09, 4328.87, 4363.49, 4386.54, 4306.26, 4373.94, 4384.65, 4288.7,
    4225.5, 4304.76, 4348.87, 4380.26, 4475.01, 4471.07, 4401.67, 4418.64,
    4504.08, 4587.18,
  ]

  it('should able get MACD with default options', () => {
    const result = macd(values)

    const expectedMACD = [
      0, -0.64, 8.69, 11.55, 14.79, 29.23, 49.54, 72.69,
      93.59, 105.77, 113.07, 122.96, 123.27, 124.57, 126.26, 118.13,
      104.1, 88.96, 78.65, 63.91, 51.58, 43.16, 49.25, 47.01,
      45.98, 37.17, 30.25, 29.74, 28.22, 37.24, 45.77, 64.15,
      67.88, 68.42, 66.19, 76.11, 74.75, 72.13, 78.9, 81.37,
      92.1, 104.7, 113.6, 113.66, 112.47, 114.58, 111, 108.13,
      110.69, 112.39, 110.92, 112.01, 116.18, 115.19, 111.87, 113.73,
      116.23, 112.38, 105.5, 97.08, 84.28, 77.7, 67.64, 59.14,
      47.71, 33.91, 15.11, -6.93, -21.62, -28.48, -32.07, -43.07,
      -48.77, -42.48, -34.31, -25.68, -25.03, -18.84, -12.92, -15.78,
      -22.89, -21.88, -17.32, -11.04, 1.56, 11.1, 12.91, 15.54,
      24.24, 37.4,
    ]

    const expectedSignal = [
      0, -0.13, 1.63, 3.62, 5.85, 10.53, 18.33, 29.2,
      42.08, 54.82, 66.47, 77.77, 86.87, 94.41, 100.78, 104.25,
      104.22, 101.17, 96.66, 90.11, 82.41, 74.56, 69.5, 65,
      61.19, 56.39, 51.16, 46.88, 43.15, 41.97, 42.73, 47.01,
      51.19, 54.63, 56.94, 60.78, 63.57, 65.28, 68.01, 70.68,
      74.96, 80.91, 87.45, 92.69, 96.65, 100.23, 102.39, 103.53,
      104.97, 106.45, 107.35, 108.28, 109.86, 110.93, 111.11, 111.64,
      112.56, 112.52, 111.12, 108.31, 103.5, 98.34, 92.2, 85.59,
      78.01, 69.19, 58.38, 45.32, 31.93, 19.85, 9.46, -1.04,
      -10.59, -16.97, -20.44, -21.48, -22.19, -21.52, -19.8, -17,
      -19.78, -20.2, -19.62, -17.91, -14.01, -8.99, -4.61, -0.58,
      4.38, 10.99,
    ]

    const expectedHistogram = [
      0, -0.52, 7.05, 7.93, 8.94, 18.7, 31.21, 43.49,
      51.51, 50.95, 46.6, 45.19, 36.4, 30.17, 25.48, 13.88,
      -0.12, -12.21, -18.01, -26.21, -30.83, -31.4, -20.25, -17.99,
      -15.21, -19.22, -20.91, -17.14, -14.93, -4.72, 3.04, 17.14,
      16.69, 13.79, 9.25, 15.33, 11.18, 6.85, 10.9, 10.69,
      17.13, 23.79, 26.15, 20.97, 15.83, 14.34, 8.61, 4.59,
      5.73, 5.94, 3.58, 3.74, 6.32, 4.26, 0.75, 2.1,
      3.67, -0.14, -5.62, -11.23, -19.23, -20.64, -24.56, -26.45,
      -30.31, -35.28, -43.27, -52.24, -53.55, -48.33, -41.53, -42.02,
      -38.18, -25.52, -13.88, -4.2, -2.84, 2.68, 6.88, 3.21,
      -3.12, -1.68, 2.31, 6.87, 15.57, 20.09, 17.52, 16.12,
      19.85, 26.42,
    ]

    expect(result.macd).toMatchNumberArray(expectedMACD)
    expect(result.signal).toMatchNumberArray(expectedSignal)
    expect(result.histogram).toMatchNumberArray(expectedHistogram)
  })

  it('should able get MACD with custom options', () => {
    const result = macd(values, {
      fastPeriod: 6,
      slowPeriod: 13,
      signalPeriod: 7,
    })

    const expectedMACD = [
      0, -1.15, 15.79, 17.73, 20.22, 42.52, 71.15, 99.76,
      119.63, 121.3, 115.53, 117.04, 102.38, 93.65, 88.21, 66.93,
      39.87, 16.36, 5.9, -11.08, -21.11, -23.11, 0.2, 2.91,
      6.72, -4.62, -10.65, -4.49, -1.94, 18.57, 33.73, 63.54,
      61.38, 54.68, 45, 59.46, 51.09, 42.63, 52.99, 53.69,
      69.34, 85.49, 92.28, 82.6, 73.43, 72.53, 62, 55.18,
      59.57, 61.53, 57.5, 58.96, 65.67, 61.84, 54.77, 58.49,
      62.55, 54.47, 42.66, 30.42, 12.55, 9.01, -0.73, -6.39,
      -16.94, -30.4, -51.02, -74.33, -81.11, -74.07, -64.11, -70.7,
      -67.51, -44.55, -23.73, -6.72, -7.5, 2, 9.26, -0.38,
      -15.29, -12.48, -3.94, 5.93, 25.27, 35.51, 30.42, 28.48,
      38.34, 54.69,
    ]

    const expectedSignal = [
      0, -0.29, 3.73, 7.23, 10.48, 18.49, 31.65, 48.68,
      66.42, 80.14, 88.99, 96, 97.6, 96.61, 94.51, 87.61,
      75.68, 60.85, 47.11, 32.56, 19.15, 8.58, 6.48, 5.59,
      5.87, 3.25, -0.22, -1.29, -1.45, 3.55, 11.1, 24.21,
      33.5, 38.8, 40.35, 45.12, 46.62, 45.62, 47.46, 49.02,
      54.1, 61.95, 69.53, 72.8, 72.95, 72.85, 70.14, 66.4,
      64.69, 63.9, 62.3, 61.46, 62.52, 62.35, 60.45, 59.96,
      60.61, 59.07, 54.97, 48.83, 39.76, 32.07, 23.87, 16.31,
      8, -1.6, -13.96, -29.05, -42.07, -50.07, -53.58, -57.86,
      -60.27, -56.34, -48.19, -37.82, -30.24, -22.18, -14.32, -10.84,
      -11.95, -12.08, -10.05, -6.05, 1.78, 10.21, 15.26, 18.57,
      23.51, 31.31,
    ]

    const expectedHistogram = [
      0, -0.86, 12.06, 10.5, 9.74, 24.03, 39.49, 51.08,
      53.21, 41.16, 26.54, 21.04, 4.79, -2.96, -6.3, -20.68,
      -35.81, -44.49, -41.21, -43.64, -40.25, -31.7, -6.29, -2.68,
      0.85, -7.87, -10.42, -3.2, -0.49, 15.02, 22.63, 39.33,
      27.88, 15.89, 4.65, 14.33, 4.48, -2.99, 5.53, 4.67,
      15.24, 23.54, 22.75, 9.8, 0.47, -0.32, -8.14, -11.22,
      -5.12, -2.37, -4.8, -2.5, 3.15, -0.51, -5.69, -1.47,
      1.94, -4.61, -12.31, -18.41, -27.21, -23.06, -24.6, -22.7,
      -24.94, -28.79, -37.07, -45.28, -39.05, -22, -10.53, -12.84,
      -7.24, 11.79, 24.46, 31.1, 22.74, 24.18, 23.58, 10.46,
      -3.34, -0.39, 6.1, 11.98, 23.49, 25.3, 15.16, 9.92,
      14.83, 23.38,
    ]

    expect(result.macd).toMatchNumberArray(expectedMACD)
    expect(result.signal).toMatchNumberArray(expectedSignal)
    expect(result.histogram).toMatchNumberArray(expectedHistogram)
  })

  it('step should produce same results as batch', () => {
    const toNum = mapOperator(toNumber)
    const batchResult = macd(values)
    const next = macd.step()
    const streamResults = values.map(v => next(v))
    expect(streamResults.map(r => r.macd)).toMatchNumberArray(
      toNum(batchResult.macd, { digits: 2 }),
    )
    expect(streamResults.map(r => r.signal)).toMatchNumberArray(
      toNum(batchResult.signal, { digits: 2 }),
    )
    expect(streamResults.map(r => r.histogram)).toMatchNumberArray(
      toNum(batchResult.histogram, { digits: 2 }),
    )
  })
})
