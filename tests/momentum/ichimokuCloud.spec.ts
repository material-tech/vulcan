/* eslint-disable antfu/consistent-list-newline */

import { toNumber } from 'dnum'
import { describe, expect, it } from 'vitest'
import { collect } from '~/base'
import { ichimokuCloud } from '~/momentum/ichimokuCloud'
import ohlcv from '../ohlcv.json' with { type: 'json' }

describe('ichimoku cloud', () => {
  const data = ohlcv

  it('should accept a non-array iterable source', () => {
    function* iterableSource() {
      yield* data
    }
    const fromArray = collect(ichimokuCloud(data))
    const fromIterable = collect(ichimokuCloud(iterableSource()))
    expect(fromIterable.length).toBe(fromArray.length)
    expect(fromIterable.map(p => toNumber(p.conversion, 2)))
      .toEqual(fromArray.map(p => toNumber(p.conversion, 2)))
  })

  it('should able to calculate ichimoku cloud with default options', () => {
    const result = collect(ichimokuCloud(data))

    const expectedConversion = [
      0, 0, 0, 0, 0, 0, 0, 0,
      171.35, 171.35, 171.35, 171.35, 171, 170.77, 170.67, 169.69,
      169.68, 170, 170, 170.32, 171.83, 172.99, 172.99, 172.99,
      173.42, 173.42, 173.42, 173.42, 173.21, 172.62, 172.62, 172.62,
      172.32, 172.42, 172.42, 172.42, 172.42, 173.31, 174.51, 174.51,
      174.87, 174.87, 174.87, 174.87, 174.87, 174.87, 174.87, 173.59,
      172.4, 172.14, 172.07, 169.77, 166.65, 164.47, 163, 162.69,
      160.82, 160.82, 160.82, 160.82, 161.67, 162.53, 162.53, 162.53,
      162.53, 166.58, 170.52, 171.68, 174.81, 175.13, 175.13, 175.13,
      175.13, 175.13, 175.13, 175.13, 176.01, 176.55, 176.55, 176.55,
      176.55, 176.55, 176.55, 176.55, 176.05, 174.2, 172.73, 172.59,
      172.03, 171.21, 170.64, 169.81, 169.81, 169.81, 169.81, 169.81,
      169.35, 169.35, 169.5, 170.31, 170.48, 173.57, 173.57, 174.29,
      172.18, 171.51, 170.08, 170.08, 170.08, 169.79, 169.73, 168.01,
      169.19, 169.19, 172.44, 174.15, 174.15, 174.15, 176.1, 177.82,
    ]

    const expectedBase = [
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 171.83, 171.83, 171.83, 171.83, 171.83, 171.83, 171.83,
      171.83, 171.83, 171.83, 171.83, 171.83, 171.91, 174.09, 174.09,
      174.44, 174.66, 174.66, 174.66, 174.66, 174.66, 174.66, 173.59,
      172.4, 172.4, 172.4, 170.1, 168.05, 167.05, 167.05, 167.05,
      165.17, 165.17, 165.17, 165.17, 165.17, 165.17, 165.17, 165.17,
      165.17, 165.17, 164.91, 165.36, 165.43, 165.43, 165.43, 165.43,
      165.43, 165.43, 165.43, 165.43, 166.32, 166.85, 166.85, 166.85,
      166.85, 166.85, 170.5, 172.55, 173.2, 174.2, 174.2, 174.2,
      174.2, 174.2, 174, 174, 174, 174, 174, 174,
      174, 174, 174, 174, 174, 174, 174, 172.5,
      172.36, 171.6, 170.08, 170.08, 170.08, 169.79, 169.79, 169.79,
      169.79, 169.79, 172.44, 174.15, 174.15, 174.15, 175.5, 175.5,
    ]

    const expectedLeadingA = [
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 172.63, 172.63, 172.52, 172.23, 172.23, 172.23,
      172.08, 172.12, 172.12, 172.12, 172.12, 172.61, 174.3, 174.3,
      174.66, 174.77, 174.77, 174.77, 174.77, 174.77, 174.77, 173.59,
      172.4, 172.27, 172.24, 169.94, 167.35, 165.76, 165.03, 164.87,
      162.99, 162.99, 162.99, 162.99, 163.42, 163.85, 163.85, 163.85,
      163.85, 165.88, 167.72, 168.52, 170.12, 170.28, 170.28, 170.28,
      170.28, 170.28, 170.28, 170.28, 171.17, 171.7, 171.7, 171.7,
      171.7, 171.7, 173.53, 174.55, 174.63, 174.2, 173.47, 173.4,
      173.11, 172.7, 172.32, 171.9, 171.9, 171.9, 171.9, 171.9,
      171.67, 171.67, 171.75, 172.15, 172.24, 173.78, 173.78, 173.39,
      172.27, 171.56, 170.08, 170.08, 170.08, 169.79, 169.76, 168.9,
      169.49, 169.49, 172.44, 174.15, 174.15, 174.15, 175.8, 176.66,
    ]

    const expectedLeadingB = [
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 170.1, 168.05, 167.05, 167.05, 167.05,
      165.17, 165.17, 165.17, 165.17, 165.17, 165.17, 165.17, 165.17,
      165.17, 165.17, 165.17, 165.36, 165.43, 165.43, 165.43, 165.43,
      165.43, 165.43, 165.43, 165.43, 166.32, 166.85, 166.85, 166.85,
      166.85, 166.85, 166.85, 166.85, 166.85, 166.85, 166.85, 166.85,
      166.85, 166.85, 166.85, 166.85, 166.85, 166.85, 166.85, 166.85,
      166.85, 166.85, 166.85, 166.85, 166.85, 166.85, 166.85, 166.85,
      166.85, 166.85, 166.85, 166.85, 170.5, 172.05, 172.05, 172.05,
      172.05, 172.05, 172.44, 174.15, 174.15, 174.15, 175.5, 175.5,
    ]

    const expectedLagging = [
      170.15, 169.98, 173.14, 174.96, 174.97, 174.09, 173.07, 169.48,
      171.85, 171.05, 169.8, 169.64, 169.01, 169.32, 169.37, 172.67,
      171.7, 172.27, 172.22, 173.97, 176.42, 174.54, 174.35, 175.01,
      175.01, 170.57, 170.6, 171.08, 169.23, 172.26, 172.23, 173.03,
      175, 174.35, 174.33, 174.29, 175.28, 177.09, 176.19, 179.1,
      179.26, 178.46, 177, 177.04, 174.22, 171.11, 171.51, 167.96,
      166.97, 167.43, 167.78, 160.5, 156.49, 163.03, 159.54, 155.15,
      156.41, 162.71, 164.34, 167.37, 172.99, 172.43, 171.85, 171.07,
      172.5, 175.5, 178.97, 178.39, 178.12, 175, 176.21, 176.82,
      176.67, 175.03, 176.94, 179.98, 181.72, 179.97, 178.44, 178.65,
      178.02, 175.3, 175.24, 171.27, 168.85, 164.94, 172.77, 168.34,
      166.48, 167.78, 166.68, 168.39, 171.61, 172.8, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0,
    ]

    expect(result.map(p => p.conversion))
      .toMatchNumberArray(expectedConversion)

    expect(result.map(p => p.base))
      .toMatchNumberArray(expectedBase)

    expect(result.map(p => p.leadingA))
      .toMatchNumberArray(expectedLeadingA)

    expect(result.map(p => p.leadingB))
      .toMatchNumberArray(expectedLeadingB)

    expect(result.map(p => p.lagging))
      .toMatchNumberArray(expectedLagging)
  })
})
